name: Check domains

on:
  schedule:
    - cron:  '*/1 * * * *'
  workflow_dispatch:

jobs:
  hello:
    runs-on: ubuntu-latest
    name: Check domain
    strategy:
      matrix:
        domain:
          - https://oliwiak.com
    steps:
      - name: Check domain SSL and registry expire date
        id: check-domain
        uses: codex-team/action-check-domain@v1
        with:
          url: ${{ matrix.domain }}

      - name: Create an issue if SSL lifespan days number is below limit
        if: ${{ steps.check-domain.outputs.ssl-expire-days-left && steps.check-domain.outputs.ssl-expire-days-left < 100 }}
        run: |
          echo 'SSL cert has ${{ steps.check-domain.outputs.ssl-expire-date }}'
          echo 'SSL cert has ${{ steps.check-domain.outputs.ssl-expire-days-left }} days left'
          echo '${{ matrix.domain }} â€” SSL cert expires in ${{ steps.check-domain.outputs.ssl-expire-days-left }} days, on: ${{ steps.check-domain.outputs.ssl-expire-date }}'
          echo ${{secrets.SLACK_WEBHOOK}}

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        if: ${{ steps.check-domain.outputs.ssl-expire-days-left && steps.check-domain.outputs.ssl-expire-days-left < 100 }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: ssl-monitor
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
          SLACK_USERNAME: test
          SLACK_MESSAGE: 'Post Content :rocket:'

      - name: Slack Notification Custom
        if: ${{ steps.check-domain.outputs.ssl-expire-days-left && steps.check-domain.outputs.ssl-expire-days-left < 100 }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: ssl-monitor
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
          SLACK_USERNAME: test
          SLACK_MESSAGE: 'Post Content :rocket:'
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"$SLACK_MESSAGE"}' $SLACK_WEBHOOK

      - name: Send custom JSON data to Slack workflow
        if: ${{ steps.check-domain.outputs.ssl-expire-days-left && steps.check-domain.outputs.ssl-expire-days-left < 100 }}
        id: slack
        uses: slackapi/slack-github-action@v1.14.0
        with:
          payload: "{{\"channel\":\"${SLACK_CHANNEL}\",\"text\":\"${SLACK_TEXT}\",\"icon_emoji\":\":skull:\",\"username\":\"${SLACK_BOTNAME}\",\"attachments\":[{\"color\":\"${COLOR}\",\"fields\":[{\"title\":\"Domain:\",\"value\":\"${DOMAIN}\",\"short\":true},{\"title\":\"Expiry day(s):\",\"value\":\"${EXPIRY_DAYS}\",\"short\":true},{\"title\":\"Expiry date:\",\"value\":\"$EXPIRY_DATE\",\"short\":true},{\"title\":\"Issued by:\",\"value\":\"$ISSUER\",\"short\":true}]}]}" # This data can be any valid JSON from a previous step in the GitHub Action
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
